#!/usr/bin/env bash
set -x

# Alternatively, you can also use:
PS4='[$(date "+%Y-%m-%d %H:%M:%S")] '
pgrep -f searchd | xargs kill -9
trap 'kill $(jobs -p)' EXIT
bin/cluster 2 >/dev/null 2>&1 &

sleep 4

mysql -h0 -P19306 -e "create table system.test (id bigint, name string, value json)"
mysql -h0 -P19306 -e "alter cluster c add system.test"
mysql -h0 -P19306 -e "show tables"


while true; do
	mysql -h0 -P29306 -e 'select * from system.test' > /dev/null 2>&1
	mysql -h0 -P19306 -e 'select * from system.test' > /dev/null 2>&1
	sleep 0.6
done & while_pid=$!

mysql -h0 -P19306 -e "insert into c:system.test values (1, 'master', '{\"a\":1}')" &
mysql -h0 -P19306 -e "insert into c:system.test values (2, 'cluster', '{\"a\":1}')" &
mysql -h0 -P19306 -e "insert into c:system.test values (3, 'node', '{\"a\":1}')" &

sleep 1.5

mysql -h0 -P19306 -e "update c:system.test set value = '{\"a\":2}' where name = 'node'" &
mysql -h0 -P29306 -e "insert into c:system.test values (4, 'slave', '{\"a\":1}')" &

mysql -h0 -P19306 -e "update c:system.test set value = '{\"a\":2}' where name = 'cluster'" &
mysql -h0 -P29306 -e "insert into c:system.test values (5, 'slave', '{\"a\":1}')" &

mysql -h0 -P19306 -e "update c:system.test set value = '{\"a\":2}' where name = 'muster'" &
mysql -h0 -P29306 -e "insert into c:system.test values (6, 'slave', '{\"a\":1}')" &

sleep 2
echo 'Waiting for all updates to be replicated'
kill $while_pid
wait

echo 'Expecting to see all 6 rows'
mysql -h0 -P19306 -e "select * from system.test"
